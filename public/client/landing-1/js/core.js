!function(){"use strict";window.Account={loginSuccess:async t=>{const e=window.Account;t.favList&&(FavList.clear(),FavList.save(),FavList.insert(t.favList),FavList.save()),t.offerWebAuth&&await e.offerWebAuth(),location.reload()},login:async(t={})=>{const e=window.Account,a=new Modal(t);let[i,n,o]=await Promise.all([a.loadFromTemplate("login.tpl",{}),fetch(`${NOW.settings.url_api}/auth/google`),NOW.Library.load(["ladda","axios","qrcodejs"])]),s=await n.json();s.google_signin_link&&i.find("a#google_signin_link").attr("href",s.google_signin_link),i.find('button[role="webauthn_signin"]').on("click",(function(){e.loginWebAuth()})),i.find('button[role="whatsapp_signin"]').on("click",(function(){e.loginWhatsapp()})),i.find("form").on("submit",(async function(t){t.preventDefault();let a=new NOW.Form(t.target);if(a.lock())return!1;try{let t=await axios.post(`${NOW.settings.url_api}/auth/login`,a.serialize());e.loginSuccess(t.data)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}a.unlock()})),a.render()},logout:()=>{FavList.clear(),FavList.save(),location.href="/logout"},register:async(t={})=>{const e=window.Account;if(NOW.session.user_id>0)return await NOW.Phrases.load(["ALERT_ALREADY_REGISTERED"]),void Alert.error("ALERT_ALREADY_REGISTERED");const a=new Modal(t);let[i,n]=await Promise.all([a.loadFromTemplate("register-step1.tpl",{}),fetch(`${NOW.settings.url_api}/auth/google`),NOW.Library.load(["ladda","axios"])]),o=await n.json();o.google_signin_link&&i.find("a#google_signin_link").attr("href",o.google_signin_link),a.render(),i.find("form").on("submit",(async function(i){i.preventDefault();let n=new NOW.Form(i.target);if(n.lock())return!1;try{await axios.post(`${NOW.settings.url_api}/auth/check/email`,n.serialize());a.hide(),e.registerForm(t)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}n.unlock()}))},registerForm:async(t={})=>{const e=window.Account,a=new Modal(t);let[i,n]=await Promise.all([a.loadFromTemplate("register-step2.tpl",{}),fetch(`${NOW.settings.url_api}/regions`),NOW.Phrases.load(["ALERT_USER_REGISTER_SUCCESS"]),NOW.Library.load(["intlTelInput","select2","ladda","axios","select2region","throttle"])]);await a.render();let o=await n.json();Cache.Region=new NOW.Collection("id",o),i.find('select[name="pub_region"]').select2region({minRegionLevel:2}),i.find(".radio-option").on("click",(function(t){t.preventDefault();var e=$(this).attr("data-target"),a=$(this).attr("data-namespace");i.find(a).removeClass("show"),i.find(e).addClass("show"),i.find(".radio-option").removeClass("selected"),$(this).addClass("selected")})),1==i.find(".radio-option").length&&i.find(".radio-option").trigger("click"),i.find("form").on("submit",(async function(t){t.preventDefault();let n=new NOW.Form(t.target);if(n.lock())return!1;try{if("user"==n.get("user_type"))n.set("favorite",FavList.get("favorite"));else{if("girl"!=n.get("user_type"))throw"user type unknown";var o=window.intlTelInputGlobals.getInstance(i.find('[name="pub_whatsapp"]')[0]);n.set("pub_whatsapp",o.getNumber())}let t=await axios.post(`${NOW.settings.url_api}${$(this).attr("data-target")}`,n.serialize());await e.offerWebAuth(),"girl"==n.get("user_type")?(t.data.isRegister=!0,e.registerComplete(t.data)):(await Alert.success("ALERT_USER_REGISTER_SUCCESS"),window.location.href="/"),a.hide()}catch(t){Alert.confirm({title:"Oops",msg:t.response?t.response.data.message:t,type:"OK"})}n.unlock()}))},registerComplete:async t=>{const e=window.Account,a=new Modal;let[i,n]=await Promise.all([a.loadFromTemplate("register-step3.tpl",{},!1),NOW.Phrases.load(["ALERT_GIRL_REGISTER_SUCCESS"]),NOW.Library.load(["ladda","axios","dropzone"])]);await a.render(),i.find("#drop-container").dropzone({url:`${NOW.settings.url_api}/profile/avatar`,method:"post",timeout:3e5,maxFilesize:20,createImageThumbnails:!1,acceptedFiles:"image/*",success:function(t){t=JSON.parse(t.xhr.response),i.find("#drop-container").html(`<img src="/upload/${t.pub_id}/avatar.jpg?${t.avatar_uploaded||"0"}" class="object-fit events-none"/>`)}}),i.find(".register-gallery").on("click",'[role="deleteGallery"]',(async function(){let t=$(this).closest(".register-gallery-item");axios.delete(`/api/profile/media/${$(this).data("media_id")}`).then((function(e){t.remove()}))})),i.find('[role="uploadGallery"]').dropzone({url:`${NOW.settings.url_api}/profile/media`,method:"post",timeout:3e5,maxFilesize:99,acceptedFiles:"image/*",createImageThumbnails:!1,success:function(t){t=JSON.parse(t.xhr.response),i.find('[role="uploadGallery"]').after(`\n                        <div class="register-gallery-item flex-shrink-0 position-relative">\n                            <img src="/upload/${t.pub_id}/${t.media_id}/${t.media_link}/270w.jpg" class="object-fit"/>\n                            <i class="btn btn-default btn-circle fa fa-times absolute-center" role="deleteGallery" data-media_id="${t.media_id}"></i>\n                        </div>`)}}),i.find("form").on("submit",(async function(i){i.preventDefault();let n=new NOW.Form(i.target);if(n.lock())return!1;try{await Promise.all([axios.post(`${NOW.settings.url_api}/profile/pub`,n.serialize()),NOW.Library.load(["whatsapp-verification","id-verification"])]),a.hide();try{if("1"==t.whatsappRegisterValidation){const e=new whatsappVerification;await e.init({canSkip:!0,pub_whatsapp:t.pub_whatsapp})}}catch(t){console.log(t)}try{if("1"==t.idRegisterVerification){const t=new idVerification;await t.init()}}catch(t){console.log(t)}e.registerSuccess()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}n.unlock()}))},registerSuccess:async()=>{await Alert.success("ALERT_GIRL_REGISTER_SUCCESS"),window.location.href="/account"},registerGoogleFail:()=>{Alert.confirm({title:"Oops",msg:"El email esta en uso",type:"OK"})},recoveryInit:async()=>{const t=window.Account,e=new Modal;let[a,i]=await Promise.all([e.loadFromTemplate("recovery-init.tpl"),NOW.Library.load(["ladda","axios"])]);e.render(),a.find('button[role="byEmail"]').on("click",(async function(a){return e.hide(),t.recoveryStep1({method:"email"})})),a.find('button[role="byWhatsapp"]').on("click",(async function(a){return e.hide(),t.recoveryStep1({method:"whatsapp"})}))},recoveryStep1:async t=>{const e=window.Account,a=new Modal;let[i,n]=await Promise.all([a.loadFromTemplate(`recovery-step-1-${t.method}.tpl`),NOW.Library.load(["ladda","axios"])]);a.render(),i.find("form").on("submit",(async function(n){n.preventDefault();let o=new NOW.Form(n.target);if(o.lock())return!1;try{if("whatsapp"==t.method){var s=window.intlTelInputGlobals.getInstance(i.find('[name="pub_whatsapp"]')[0]);s&&o.set("pub_whatsapp",s.getNumber())}await axios.post(`${NOW.settings.url_api}/auth/recovery/${t.method}`,o.serialize());return a.hide(),e.recoveryStep2(o.getAll(),t)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}o.unlock()}))},recoveryStep2:async(t,e={})=>{const a=window.Account,i=new Modal;let[n]=await Promise.all([i.loadFromTemplate(`recovery-step-2-${e.method}.tpl`,t)]);i.render(n,{stack:!1}),n.find("form").on("submit",(async function(t){t.preventDefault();let e=new NOW.Form(t.target);if(e.lock())return!1;try{let t=await axios.post(`${NOW.settings.url_api}/auth/recovery/code`,e.serialize());a.loginSuccess(t.data)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}e.unlock()}))},registerWebAuth:async()=>{try{await NOW.Library.load(["axios"]);let t=await axios.get("/api/auth/register/webauthn"),e=t.data;NOW.Utils.recursiveBase64StrToArrayBuffer(e);const a=await navigator.credentials.create(e),i={transports:a.response.getTransports?a.response.getTransports():null,clientDataJSON:a.response.clientDataJSON?NOW.Utils.arrayBufferToBase64(a.response.clientDataJSON):null,attestationObject:a.response.attestationObject?NOW.Utils.arrayBufferToBase64(a.response.attestationObject):null};t=await axios.post("/api/auth/register/webauthn",i),console.log(t)}catch(t){console.error(t),Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}},offerWebAuth:()=>{const t=window.Account;if("true"!==localStorage.getItem("skipPasskeyCreationAtLogin")&&"credentials"in navigator)return new Promise((async(e,a)=>{await NOW.Library.twig("passkey");const i=new Modal({callback:{onClose:function(){e()}}}),n=await i.loadFromTemplate("passkey_register.tpl",{});i.render(),n.find('button[role="skip"]').on("click",(function(){localStorage.setItem("skipPasskeyCreationAtLogin","true"),i.hide()})),n.find('button[role="register"]').on("click",(async function(){await t.registerWebAuth(),i.hide()}))}))},loginWebAuth:async()=>{try{const t=window.Account;await NOW.Library.load(["axios"]);let e=await axios.get("/api/auth/login/webauthn"),a=e.data;console.log(a),NOW.Utils.recursiveBase64StrToArrayBuffer(a),console.log(a);const i=await navigator.credentials.get(a),n={id:i.rawId?NOW.Utils.arrayBufferToBase64(i.rawId):null,clientDataJSON:i.response.clientDataJSON?NOW.Utils.arrayBufferToBase64(i.response.clientDataJSON):null,authenticatorData:i.response.authenticatorData?NOW.Utils.arrayBufferToBase64(i.response.authenticatorData):null,signature:i.response.signature?NOW.Utils.arrayBufferToBase64(i.response.signature):null,userHandle:i.response.userHandle?NOW.Utils.arrayBufferToBase64(i.response.userHandle):null};e=await axios.post("/api/auth/login/webauthn",n),t.loginSuccess(e.data)}catch(t){console.error(t),Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}},loginWhatsapp:async()=>{await NOW.Library.load(["axios","ladda"]);const t=window.Account,e=new Slide,a=new Modal({class:"login-whatsapp modal-sm"});async function i(e,a,i){try{let n=await axios.post(`${NOW.settings.url_api}/auth/login/whatsapp`,{whatsapp_number:e,verification_code:a,user_id:i});t.loginSuccess(n.data)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}}function n(t){a.setStep(2);const n=e.loadFromTemplate("login-whatsapp-2.tpl",{whatsapp_number:t});e.setLastSlide(),async function(){var t=Ladda.create(n.find('button[role="changeNumber"]')[0]);t.start(),await sleep(1e4),t.stop()}(),async function(){var t=Ladda.create(n.find('button[role="resendCode"]')[0]);t.start(),await sleep(1e4),t.stop()}(),n.find('button[role="changeNumber"]').on("click",(function(t){t.preventDefault(),e.pop()})),n.find('button[role="resendCode"]').on("click",(async function(e){e.preventDefault();var a=Ladda.create(this);a.start();try{await axios.post(`${NOW.settings.url_api}/auth/login/whatsapp`,{whatsapp_number:t}),await sleep(1e4)}catch(t){console.log(t)}finally{a.stop()}})),n.find("form").on("submit",(async function(n){n.preventDefault();let o=new NOW.Form(n.target);if(o.lock())return!1;try{const n=o.get("verification_code"),s=await axios.post(`${NOW.settings.url_api}/auth/login/whatsapp`,{verification_code:n,whatsapp_number:t});1==s.data.accounts.length?i(t,n,s.data.accounts[0].user_id):function(t,n,o){a.setStep(3);const s=e.loadFromTemplate("login-whatsapp-3.tpl",o);e.setLastSlide(),s.find("[data-whatsapp]").text(t),s.find("[data-user_id]").on("click",(function(){const e=$(this).data("user_id");s.find("[data-user_id]").attr("disabled",!0),i(t,n,e)}))}(t,n,s.data)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}finally{o.unlock()}}))}a.create(),a.createSteps(3),a.attachSlide(e),function(){a.setStep(1);const t=e.loadFromTemplate("login-whatsapp-1.tpl");e.setLastSlide(),t.find("form").on("submit",(async function(e){e.preventDefault();let a=new NOW.Form(e.target);if(a.lock())return!1;try{const e=window.intlTelInputGlobals.getInstance(t.find('[name="whatsapp_number"]')[0]).getNumber();await axios.post(`${NOW.settings.url_api}/auth/login/whatsapp`,{whatsapp_number:e}),n(e)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}finally{a.unlock()}}))}(),a.render()}}}(),function(){"use strict"}(),function(){"use strict";NOW.Listing=class{constructor(t={}){this.tpl=$("#page"),this.options=t}initialized=!1;async init(t={}){const e=this;e.initialized||(e.initialized=!0,e.tpl.on("click",'[data-trigger^="Listing."]',(function(t){const a=t.currentTarget;if(void 0===a.dataset.allowPropagation&&t.stopPropagation(),"Listing.loadMore"===a.dataset.trigger)e.loadMore(a)})),NOW.Utils.isMobile()&&!NOW.Utils.isMobile("iOS")&&e.improveVideoScroll(),e.initCovers(),e.initSearch(),e.loadVideos(),e.initDynamicContent(),e.tpl.find('.listing-type-story[data-plugin="story"]').story(),FavList.listingOnChange())}loadedVideos=[];initCovers(){const t=new IntersectionObserver(((t,e)=>{const a=this;for(let e of t){let t=e.target;if(e.isIntersecting){if(-1==a.loadedVideos.indexOf(t)){if(a.loadedVideos.length>30){for(let t=0;t<10;t++){let e=a.loadedVideos[t].src;a.loadedVideos[t].removeAttribute("src"),a.loadedVideos[t].load(),a.loadedVideos[t].setAttribute("src",e)}a.loadedVideos.splice(0,10)}a.loadedVideos.push(t)}t.dataset.loaded=!0,t.dataset.play=!0,t.readyState>=2?0==a.isScrolling&&t.play():(t.load(),t.onloadeddata=e=>{if(t.readyState>=2&&(t.play(),0!=a.isScrolling)){let e=t.play();void 0!==e&&e.then((()=>{t.paused||t.pause()})).catch((t=>{console.warn("Error al intentar pausar el video:",t)}))}})}else if(t.dataset.play=!1,"true"==t.dataset.loaded){let e=t.play();void 0!==e&&e.catch((t=>{console.warn("Error al intentar reproducir el video:",t)}))}}}),{root:null,rootMargin:"0px 0px 0px 0px",threshold:0});if(!(NOW.Utils.isMobile("Android")&&NOW.Utils.getAndroidVer()<8))for(let e of document.querySelectorAll(".listing-video:not([data-observing])"))e.dataset.observing=!0,t.observe(e)}initSearch(){const t=this,e=t.tpl.find("#show_search_bar");var a,i,n,o;e&&e.on("click",(function(t){Cookies.set("show_search_bar",this.classList.contains("collapsed")?0:1,{expires:7})})),t.tpl.find("#searchRegion").on("click",(async function(){let[e]=await Promise.all([i?null:fetch(`${NOW.settings.url_api}/regions/${t.options.region_country}`),NOW.Library.load(["select2","select2region","throttle"])]);if(!i){i=await e.json(),Cache.Region=new NOW.Collection("id",i);let t=$(this).find("select");o=await t.select2region({insertInputs:!1,theme:"default select2-escorts select2-escorts-region"}),t.on("change",(function(t){window.location=`${NOW.settings.url_region}/${Cache.Region.get($(this).val(),"region_url")}`}))}o.s2inst.select2("open")})),t.tpl.find("#searchEscort").on("click",(async function(){let[e]=await Promise.all([a?null:fetch("/api/fetch/static"),NOW.Library.load(["select2"])]);a||(a=await e.json(),(n=$(this).find("select").select2({minimumInputLength:3,ajax:{type:"POST",url:`/api/fetch/pubs/${t.options.region_id}`,dataType:"json",delay:500,params:{contentType:"application/json; charset=utf-8"},data:function(t){return{search:t.term}},processResults:function(t){return{results:t}}},templateResult:function(t){if(!t.pub_id)return t;let e=`\n\t\t\t\t\t\t\t\t<div class="d-flex align-items-center">\n\t\t\t\t\t\t\t\t\t<picture class="avatar avatar-md mr-10 flex-shrink-0">\n\t\t\t\t\t\t\t\t\t\t<img\tsrc="${NOW.settings.url_media}/${t.pub_id}/avatar.jpg?${t.pub_cover_mod}"\n\t\t\t\t\t\t\t\t\t\t\t\tdata-fallback="${NOW.settings.url_assets}/images/default.png"\n\t\t\t\t\t\t\t\t\t\t\t\tclass="object-fit" />\n\t\t\t\t\t\t\t\t\t</picture>\n\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t<h5 class="mb-0 font-size-14">${t.pub_title}</h5>\n\t\t\t\t\t\t\t\t\t\t<div class="font-size-12">${t.pub_province_name||""} ${t.pub_city_name||""} ${t.pub_zone_name||""}</div>\n\t\t\t\t\t\t\t\t\t\t<div class="d-flex align-items-center flex-wrap">`;for(let e of NOW.Utils.split(t.pub_category));return e+="\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>",$(e)},theme:"default select2-escorts",escapeMarkup:function(t){return t}})).on("select2:select",(function(t){var e=t.params.data;window.location=`${NOW.settings.url_region}/${e.pub_slug}`}))),n.select2("open"),t.tpl.find(".select2-search__field").focus()}))}initDynamicContent(){const t=this;let e=new IntersectionObserver(t.infinityScroll.bind(t),{root:null,rootMargin:"400px 0px 400px 0px",threshold:0});for(let a of t.tpl.find('.pagination[data-plugin="infinity_scroll"]:not([data-block_type="scroll"]), .pagination[data-plugin="infinity_scroll_extreme"]'))parseInt(a.dataset.start)<parseInt(a.dataset.end)&&e.observe(a);for(let e of t.tpl.find('.pagination[data-plugin="infinity_scroll"][data-block_type="scroll"]')){let a=new IntersectionObserver(t.infinityScroll.bind(t),{root:NOW.Utils.isMobile()?e.parentElement:e.parentElement.parentElement,rootMargin:"0px 400px 0px 400px",threshold:0});parseInt(e.dataset.start)<parseInt(e.dataset.end)&&a.observe(e)}let a=new IntersectionObserver(t.infinityScrollWidget.bind(t),{root:null,rootMargin:"400px 0px 400px 0px",threshold:0});for(let e of t.tpl.find('div[data-plugin="widget"]'))a.observe(e)}isScrolling=!1;improveVideoScroll(){const t=this;window.addEventListener("scroll",throttle(20,(function(e){if(console.log("scrolling"),0==t.isScrolling)for(let t of document.querySelectorAll('video[data-play="true"]')){let e=t.play();void 0!==e&&e.then((()=>{t.paused||t.pause()})).catch((t=>{console.warn("Error al intentar pausar el video:",t)}))}window.clearTimeout(t.isScrolling),t.isScrolling=setTimeout((function(){t.isScrolling=!1;for(let t of document.querySelectorAll('video[data-play="true"]')){let e=t.play();void 0!==e&&e.catch((t=>{console.warn("Error al intentar reproducir el video:",t)}))}}),100)})),!1)}async loadVideos(){let t=this.tpl.find('.section-listing[data-plugin="video"]');t.length&&await NOW.Library.load("magnificPopup");for(let e of t)$(e).magnificPopup({delegate:"a.video__link",mainClass:"fade show",type:"inline",gallery:{enabled:!0,navigateByImgClick:!0},callbacks:{open:function(){var t=$.magnificPopup.instance,e=$.magnificPopup.proto;$(".mfp-container").addClass("mfp-image-holder").removeClass("mfp-inline-holder"),$(".mfp-container").swipe({swipeLeft:function(t,e,a,i,n){$.magnificPopup.instance.next()},swipeRight:function(t,e,a,i,n){$.magnificPopup.instance.prev()}}),t.next=function(){t.index<t.items.length-1&&e.next.call(t)},t.prev=function(){t.index>0&&e.prev.call(t)};for(let t of $.magnificPopup.instance.ev[0].querySelectorAll(".video__link:not([data-loaded])"))t.dataset.loaded=!0},beforeClose:function(){let t=$(".mfp-container").find("video");t.length>0&&t[0].pause()},afterClose:function(){if(location.search.length){let t=location.toString().replace(location.search,"");window.history.pushState({query:t},"",t)}},change:function(t){let e=this;if(e.currItem.el[0].scrollIntoView(),null!=this.gallery_content_prev){let t=this.gallery_content_prev.find("video");if(t.length){t[0].pause();let e=t.attr("src");t[0].removeAttribute("src"),t[0].load(),t.attr("src",e)}}e.gallery_content_prev=e.content;let a=e.content[0].querySelector("video"),i=e.index;a&&(a.readyState>=2?a.play():(a.load(),a.onloadeddata=t=>{a.readyState>=2&&i==$.magnificPopup.instance.index&&a.play()}))}}})}updateVideos(t){if(!$.magnificPopup||!$.magnificPopup.instance.items)return;let e=$.magnificPopup.instance;$.magnificPopup.instance.isOpen&&t.id==$.magnificPopup.instance.ev[0].id&&(e.items.push(...e.ev[0].querySelectorAll(".video__link:not([data-loaded])")),e.updateItemHTML())}infinityScrollWidget(t,e){async function a(t){fetch(t.dataset.api+"/"+t.dataset.id,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.dataset)}).then((function(t){return t.text()})).then((function(e){e.length>50&&t.classList.add("widget-showing"),t.insertAdjacentHTML("afterbegin",e),NOW.Page.loadPlugins($(t))})).catch((function(t){console.warn("Something went wrong.",t)}))}for(let i of t){let t=i.target;i.isIntersecting&&(a(t),e.unobserve(t))}}infinityScroll(t,e){const a=this;async function i(t){t.dataset.loading=!0;let i=t.dataset.block_id,n=document.getElementById("block-"+i),o=parseInt(t.dataset.start),s=parseInt(t.dataset.end);t.dataset.start=parseInt(t.dataset.start)+1,o+1>=s&&e.unobserve(t);let r=o*parseInt(t.dataset.iteration)+parseInt(t.dataset.iteration)>parseInt(t.dataset.total)?parseInt(t.dataset.total)-o*parseInt(t.dataset.iteration):parseInt(t.dataset.iteration);n.querySelector(".listing-additional").insertAdjacentHTML("beforebegin",`<div class="listing-pub" data-block_id="${i}" data-pagination-loading="${o}">\n\t\t\t\t\t<div class="cover">\n\t\t\t\t\t\t<div class="listing-image">\n\t\t\t\t\t\t\t<div class="lds-ring absolute-center"><div></div><div></div><div></div><div></div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`.repeat(r));const l=await fetch(`/api/fetch/block/${i}/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.dataset)}),d=await l.text();if(n.querySelector(".listing-additional").insertAdjacentHTML("beforebegin",d),document.querySelectorAll(`.listing-pub[data-block_id="${i}"][data-pagination-loading="${o}"]`).forEach((t=>t.remove())),$(n).css("--elements-count",$(n).children().length||0),a.initCovers(),a.updateVideos(n),FavList.listingOnChange(n),t.dataset.loading=!1,"infinity_scroll_extreme"==t.dataset.plugin&&"scroll"==t.dataset.block_type&&0==o){e.unobserve(t);let i={root:NOW.Utils.isMobile()?t.parentElement:t.parentElement.parentElement,rootMargin:"0px 400px 0px 400px",threshold:0};new IntersectionObserver(a.infinityScroll.bind(a),i).observe(t)}}for(let a of t){let t=a.target;if(a.isIntersecting&&1!=t.dataset.loading){if(parseInt(t.dataset.start)>=parseInt(t.dataset.end))return void e.unobserve(t);i(t)}}}async loadMore(t){const e=this;let a=t.parentNode;await async function(t){let a=t.dataset.block_id,i=document.getElementById("block-"+a);t.dataset.loading=!0;let n=parseInt(t.dataset.start)*parseInt(t.dataset.iteration)+parseInt(t.dataset.iteration)>parseInt(t.dataset.total)?parseInt(t.dataset.total)-parseInt(t.dataset.start)*parseInt(t.dataset.iteration):parseInt(t.dataset.iteration);i.querySelector(".listing-additional").insertAdjacentHTML("beforebegin",`<div class="listing-pub" data-block_id="${a}" data-pagination-loading="${t.dataset.start}">\n\t\t\t\t\t<div class="cover">\n\t\t\t\t\t\t<div class="listing-image">\n\t\t\t\t\t\t\t<div class="lds-ring absolute-center"><div></div><div></div><div></div><div></div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>`.repeat(n));const o=await fetch(`/api/fetch/block/${a}/${t.dataset.start}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.dataset)}),s=await o.text();i.querySelector(".listing-additional").insertAdjacentHTML("beforebegin",s),document.querySelectorAll(`.listing-pub[data-block_id="${a}"][data-pagination-loading="${t.dataset.start}"]`).forEach((t=>t.remove())),$(i).css("--elements-count",$(i).children().length||0),e.initCovers(),e.updateVideos(i),FavList.listingOnChange(i),t.dataset.loading=!1,t.dataset.start=parseInt(t.dataset.start)+1}(a),parseInt(a.dataset.start)>parseInt(a.dataset.end)&&t.remove()}}}(),function(){"use strict";NOW.Page=class{static async load(t){await NOW.Library.load(t)}static async initTask(t,e){const a=t=>{let a,i=200,n=document.getElementsByClassName("task-list")[0],o=t.querySelector(".task-right");const s=()=>{t.classList.remove("completing"),t.classList.add("completed"),n.removeChild(t),n.appendChild(t),(()=>{let e=900;t.style.marginLeft=e+"px";let a=setInterval((()=>{e>0?t.style.marginLeft=(e-=20)+"px":clearInterval(a)}),10)})()},r=()=>{a=0,t.style.marginLeft=a+"px",t.isMouseDown=!1},l=()=>{t.classList.remove("deleting"),t.classList.remove("completing")},d=e=>{if(t.isMouseDown){if(t.touchStartX&&e.touches?a=e.touches[0].pageX-t.touchStartX:a+=e.movementX,a>0)return;a>i?(t.classList.add("completing"),a=i):a<-200?(t.classList.add("deleting"),a=-200):l(),t.style.marginLeft=a+"px",o.style.opacity=Math.abs(a)/i}},c=a=>{t.isMouseDown=!1,document.removeEventListener("mouseup",c),document.removeEventListener("mousemove",d),r(),t.classList.contains("completing")?s():t.classList.contains("deleting")&&(e.onDelete&&e.onDelete(t),t.classList.remove("deleting"),n.removeChild(t))},p=e=>{r(),t.isMouseDown=!0,e.touches&&(t.touchStartX=e.touches[0].pageX),document.addEventListener("mousemove",d,!1),t.addEventListener("touchmove",d,!1),document.addEventListener("mouseup",c,!1)};t.addEventListener("touchstart",p,!1),t.addEventListener("touchend",c,!1),t.addEventListener("mousedown",p,!1),t.addEventListener("click",(t=>{t.preventDefault(),t.target.dataset.trigger||t.target.dataset.track||t.stopPropagation()}),!1),t.addEventListener("mouseup",c,!1)};let i=t.getElementsByClassName("task");for(let t=0;t<i.length;t++)i[t].id="task_"+t,a(i[t])}static initialized=!1;static async init(){const t=this;if(NOW.session={},NOW.vars={},t.initialized)return;t.initialized=!0,$(document).on("error","img[data-fallback]",(function(){$(this).attr("src",$(this).attr("data-fallback"))})),$("body").on("touchstart","[data-trigger]",(()=>{})),FavList.init(),Post.init(),$("body").on("click",'[data-track="click"]',(async function(e){const a=e.currentTarget;t.sendEvent(a)})),$("#themeSelector").on("change",(function(t){t.preventDefault(),t.stopPropagation();const e=$(this).val(),a=new Date;a.setTime(a.getTime()+31536e6);let i="expires="+a.toUTCString();document.cookie=`theme=${e}; expires=${i}; path=/;"`,$("html").removeClassRegex(/^theme-/).addClass(`theme-${e}`)})),t.DropdownMultilevel(),t.loadPlugins($),t.initLocale();let e=parseInt(localStorage.getItem("_viewCount")||0)+1;localStorage.setItem("_viewCount",e);let a=parseInt(localStorage.getItem("_feedback")||0);e>6&&0==a&&localStorage.setItem("_feedback",1);let i=document.getElementById("back-to-top"),n=document.getElementById("global-publish-btn");window.addEventListener("scroll",throttle(100,(function(){document.documentElement.scrollTop>1e3?(i.classList.add("show"),n&&n.classList.add("d-none")):(i.classList.remove("show"),n&&n.classList.remove("d-none"))}))),NOW.vars=$("#page-vars").data(),NOW.session=$("#page-session").data(),NOW.settings=$("#page-settings").data("values");const o=$("#page-news").data();o&&t.loadNews(o);const s=$("#page").data();switch(s.module){case"Publication":window.Page=new NOW.Publication(s.pub_id,s.options),window.Page.init();break;case"Listing":window.Page=new NOW.Listing(s.options),window.Page.init();break;case"Profile":window.Page=new NOW.Profile(s.options),window.Page.init()}$("body").on("click",'[data-trigger^="Global."],[data-trigger^="Auth."],[data-trigger^="Whatsapp."],[data-trigger^="UploadGallery."],[data-trigger^="UploadStory."]',(async function(e){const a=e.currentTarget;switch(void 0===a.dataset.allowPropagation&&e.stopPropagation(),a.dataset.trigger){case"Auth.login":window.Account.login();break;case"Auth.register":window.Account.register();break;case"Auth.logout":window.Account.logout();break;case"Auth.recovery":window.Account.recoveryInit();break;case"UploadGallery.init":await NOW.Library.load(["UploadGallery"]),UploadGallery.init();break;case"UploadStory.init":await NOW.Library.load(["UploadStory"]),UploadStory.init();break;case"Global.loadNews":t.loadNews();break;case"Whatsapp.send":t.sendWhatsapp(a.dataset);break;case"Global.copy":const e=document.createElement("textarea");e.value=a.dataset.value,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}})),document.dispatchEvent(new CustomEvent("NOWInitialized")),await NOW.Library.load(["notification"]),new NotificationManager}static async initLocale(){$('a[role="locale"]').on("click",(function(t){t.preventDefault(),Cookies.set("locale",$(this).attr("data-lang"),{expires:3650}),location.reload()}))}static sendEvent(t){fetch("/api/stats/event",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.dataset)})}static sendWhatsapp(t){const e=t.whatsappPhone??NOW.vars.phones.admin;let a=NOW.vars.phones[t.whatsappType]?NOW.vars.phones[t.whatsappType]:t.whatsappText??"";var i,n;let o;i=a,(n=document.createElement("textarea")).innerHTML=i,a=n.value,a=encodeURIComponent(a),o=NOW.Utils.isMobile()?`whatsapp://send?phone=${(NOW.vars.phones[t.whatsappChannel]??e).replace(/[^0-9]/g,"")}&text=${a}`:`https://api.whatsapp.com/send?phone=${(NOW.vars.phones[t.whatsappChannel]??e).replace(/[^0-9]/g,"")}&text=${a}`,NOW.Utils.openLink(o)}static async sendFeedback(t){const e=new Modal;let[a]=await Promise.all([e.loadFromServer("feedback",{}),NOW.Library.load(["dropzone"])]);e.render()}static DropdownMultilevel(){$(".dropdown-multilevel").parent().on("shown.bs.dropdown",(function(t){const e=$(this).children(".dropdown-menu"),a=e.offset(),i=e.children(".dropdown-level");e.css("--offsetTop",a.top+"px").css("--offsetLeft",a.left+"px"),i.addClass("show")})),$(".dropdown-multilevel").parent().on("hidden.bs.dropdown",(function(t){$(this).children(".dropdown-multilevel").attr("data-level",1).css("height","auto"),$(this).children(".dropdown-menu.show").removeClass("show")})),$(".dropdown-menu").on("click",'[data-toggle="dropdown"]',(function(t){t.stopPropagation();let e=$(this).next(".dropdown-menu"),a=$(this).closest(".dropdown-multilevel");return a.find(".dropdown-menu.show").removeClass("show"),a.find(".dropdown-level.show").removeClass("show"),e.addClass("show"),a.attr("data-level",2),a.css("height",e.children(".dropdown-content").height()+16),!1})),$(".dropdown-menu .dropdown-back").on("click",(function(t){t.stopPropagation();let e=$(this).parents(".dropdown-level");$(this).closest(".dropdown-menu.show").removeClass("show"),$(this).closest(".dropdown-multilevel").attr("data-level",e.length-1),$(this).closest(".dropdown-multilevel").children(".dropdown-level").addClass("show"),$(this).closest(".dropdown-multilevel").css("height","auto")}))}static async loadPlugins(t){await Promise.all([window.Plugins.load(t)]),$(t).find(".card__loading").removeClass("card__loading")}static async loadNews(t){async function e(t={}){let e=await fetch("/api/fetch/news?"+new URLSearchParams(t));return await e.json()}async function a(t,e){if(e.empty)return t.find(".modal-body").append(e.empty),void t.find('button[role="loadMore"]').remove();if(1==e.show){let a=Twig.twig({data:'{% for row in list %}<div class="ql-editor" data-news_date="{{row.news_date}}"><small class="d-block">{{row.news_date_formatted}}</small>{{row.news_content}}</div><hr>{% endfor %}'}).render(e);t.find(".modal-body").append(a)}(0==e.show||e.list.length<3)&&t.find('button[role="loadMore"]').remove()}const i=new Modal;let[n]=await Promise.all([i.loadFromTemplate("news-modal.tpl"),NOW.Library.load(["quill"])]);i.render(),null==t&&((t=await e({news_country:NOW.vars.country_id||null})).show||(await NOW.Phrases.load(["NEWS_EMPTY"]),t.empty=NOW.Phrases.get("NEWS_EMPTY"))),a(n,t),n.find('button[role="loadMore"]').click((async function(){let i=n.find(".ql-editor[data-news_date]").last().attr("data-news_date");t=await e({news_date:i,news_country:NOW.vars.country_id}),a(n,t)}))}}}(),document.addEventListener("DOMContentLoaded",(function(t){NOW.Library.load(["axios","ladda"]),NOW.Page.init()})),function(){"use strict";NOW.Profile=class{options={};constructor(t={}){this.tpl=$("#page"),this.options=t}regionInitialized=null;initialized=!1;async init(){const t=this;t.initialized||(t.initialized=!0,t.tpl.on("click",'[data-trigger^="Profile."]',(function(e){const a=e.currentTarget;switch(void 0===a.dataset.allowPropagation&&e.stopPropagation(),a.dataset.trigger){case"Profile.closeMenu":t.closeMenu(a);break;case"Profile.toggleMenu":t.toggleMenu();break;case"Profile.modalSelect":t.modalSelect(a)}})),t.regionInitialized=t.initRegions(),t.initBinds())}async initRegions(){let[t]=await Promise.all([fetch(`${NOW.settings.url_api}/regions`),NOW.Library.load(["select2region"])]),e=await t.json();Cache.Region=new NOW.Collection("id",e),this.tpl.find('select[name="pub_region"]').select2region({minRegionLevel:2})}async initBinds(){const t=this;let[e]=await Promise.all([NOW.Library.load(["intlTelInput","select2","ladda","axios","transaction","moment"])]);t.tpl.find('input[name="pub_full_time"]').on("change",(function(){$(this).prop("checked")?t.tpl.find(".working_time").hide():t.tpl.find(".working_time").show()})).trigger("change"),t.tpl.find('input[name="weekly"]').on("change",(function(){$(this).prop("checked")?(t.tpl.find(".weekly").show(),t.tpl.find(".daily").hide()):(t.tpl.find(".weekly").hide(),t.tpl.find(".daily").show())})).trigger("change"),t.tpl.find(".working_time").find("input").on("change",(function(t){$(this).attr("value",$(this).val())})),t.tpl.find(".working_time").find("button").on("click",(function(t){t.preventDefault(),$(this).parent().find("input").val(null).trigger("change"),$(this).blur()}));for(let e of t.tpl.find('input[data-plugin="time"]'))$(e).attr("type","text").val($(e).val().replace(/(\d+):(\d+):\d+/g,"$1:$2"));t.tpl.find('input[data-plugin="time"]').timeDropper({minutesSteps:15,setCurrentTime:!1,mousewheel:!0,meridians:!1,format:"H:mm"}),t.tpl.find("#pubEditForm").on("submit",(async function(t){t.preventDefault();let e=new NOW.Form(t.target);if(e.lock())return!1;try{await axios.post(`${NOW.settings.url_api}/profile/pub`,e.serialize());Alert.confirm({title:'<i class="fa fa-exclamation-circle fa-2x"></i>',msg:"Configuración guardada.",type:"OK"},{autoclose:1e3})}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"}),console.log(t)}e.unlock()})),t.tpl.find('[data-trigger="Account.ChangePassword"]').on("click",(async function(){const t=new Modal,[e]=await Promise.all([t.loadFromServer("account-change-password"),NOW.Library.load(["ladda","axios"]),NOW.Phrases.load(["ERR_PASSWORDS_DO_NOT_MATCH"])]);function a(){const t=document.getElementsByName("new_password")[0],e=document.getElementsByName("confirm_new_password")[0];t.value!==e.value?e.setCustomValidity(NOW.Phrases.get("ERR_PASSWORDS_DO_NOT_MATCH")):e.setCustomValidity("")}e.find("input[name='new_password']").on("change",(()=>a())),e.find("input[name='confirm_new_password']").on("keyup",(()=>a())),e.find("form").on("submit",(async function(e){e.preventDefault();const a=new NOW.Form(e.target);if(a.lock())return!1;try{await Promise.all([axios.post(`${NOW.settings.url_api}/profile/account/password`,a.serialize()),NOW.Phrases.load(["ACCOUNT_PASSWORD_UPDATED","ACCOUNT_PASSWORD_UPDATED_DESCRIPTION"])]),Alert.confirm({title:NOW.Phrases.get("ACCOUNT_PASSWORD_UPDATED"),msg:NOW.Phrases.get("ACCOUNT_PASSWORD_UPDATED_DESCRIPTION"),type:"OK"}),t.hide()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}a.unlock()})),t.render(e)})),t.tpl.find('[data-trigger="Account.DeleteAccount"]').on("click",(async function(){await NOW.Phrases.load(["ACCOUNT_DELETE_CONFIRM","ACCOUNT_DELETE_CONFIRM_DESCRIPTION"]),Alert.delete({title:NOW.Phrases.get("ACCOUNT_DELETE_CONFIRM"),msg:NOW.Phrases.get("ACCOUNT_DELETE_CONFIRM_DESCRIPTION")}).then((async()=>{await Promise.all([NOW.Phrases.load(["ACCOUNT_DELETED","ACCOUNT_DELETED_DESCRIPTION"]),NOW.Library.load(["ladda","axios"])]),axios.delete(`${NOW.settings.url_api}/profile/account/delete`).then((()=>{Alert.modal({title:NOW.Phrases.get("ACCOUNT_DELETED"),msg:NOW.Phrases.get("ACCOUNT_DELETED_DESCRIPTION"),type:"OK"}).then((()=>{window.location.href="/"}))})).catch((t=>{Alert.error(null,t.response.data.message)}))}))})),t.tpl.find('[data-trigger="Profile.viewActiveSessions"]').on("click",(async function(){try{this.setAttribute("disabled",!0);const t=await axios.get("/api/profile/sessions"),e=new Modal,a=await e.loadFromHTML(t.data.modal);e.render(),a.find('button[role="revoke"]').on("click",(async function(){try{var t=Ladda.create(this);t.start();const e=$(this).data("login_id");await axios.delete(`/api/profile/sessions/${e}`),a.find(`[data-login_id='${e}']`).remove(),0==a.find('[data-can-revoke="1"]').length&&a.find('button[role="revokeAll"]').remove()}catch(t){Alert.error(null,t.response.data.message)}finally{t.stop()}})),a.find('button[role="revokeAll"]').on("click",(async function(){try{var t=Ladda.create(this);t.start(),await axios.delete("/api/profile/sessions"),a.find('[data-can-revoke="1"]').remove(),$(this).remove()}catch(t){Alert.error(null,t.response.data.message)}finally{t.stop()}}))}catch(t){Alert.error(null,t.response.data.message)}finally{this.removeAttribute("disabled")}})),t.tpl.find('[data-trigger="Profile.viewWebAuth"]').on("click",(async function(){try{this.setAttribute("disabled",!0);const t=await axios.get("/api/profile/webauthn"),e=new Modal,a=await e.loadFromHTML(t.data.modal);e.render(),a.find('button[role="register"]').on("click",(async function(){await window.Account.registerWebAuth(),e.hide()})),a.find('button[role="revoke"]').on("click",(async function(){try{var t=Ladda.create(this);t.start();const e=$(this).data("webauth_id");await axios.delete(`/api/profile/webauthn/${e}`),a.find(`[data-webauth_id='${e}']`).remove()}catch(t){Alert.error(null,t.response.data.message)}finally{t.stop()}}))}catch(t){Alert.error(null,t.response.data.message)}finally{this.removeAttribute("disabled")}})),t.tpl.find(".tab-content").removeClass("d-none"),t.tpl.find('input[name="pub_whatsapp"][readonly]').on("click",(async function(){await NOW.Library.load(["whatsapp-verification"]);try{const e=new whatsappVerification,a=await e.init(),i=document.getElementById("input-pub_whatsapp");window.intlTelInputGlobals.getInstance(i).setNumber(a),t.tpl.find("div[data-pub_whatsapp_verified]").attr("data-pub_whatsapp_verified",1)}catch(t){console.log(t)}})),t.tpl.find(".account-menu-content-trigger").swipe({swipeLeft:function(e,a,i,n,o){t.closeMenu()}}),t.tpl.find("button[role='buyPlan']").on("click",(async function(){await NOW.Library.load(["transaction","datatable","moment"]),Transaction.orderPage()})),t.tpl.find("button[role='pending-orders']").on("click",(function(){axios.get(`${NOW.settings.url_api}/transactions/orders/pending`).then((t=>{const e=new Modal;e.create(t.data),e.render()}),(()=>{}))})),t.tpl.find('button[role="pause-on"]').on("click",(async function(){const t=new Modal;let[e]=await Promise.all([t.loadFromServer("status-pause",{}),NOW.Library.load(["ladda","axios"])]);t.render(),e.on("submit",(async function(t){t.preventDefault();let e=new NOW.Form(t.target);if(e.lock())return!1;try{await axios.post(`${NOW.settings.url_api}/profile/mode/pause`,e.serialize());location.reload()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}e.unlock()}))})),t.tpl.find('button[role="pause-off"]').on("click",(async function(){await Promise.all([NOW.Library.load(["axios"]),NOW.Phrases.load(["PAUSE_OFF_TITLE","PAUSE_OFF_MSG","PAUSE_OFF"])]),Alert.modal({title:NOW.Phrases.get("PAUSE_OFF_TITLE"),msg:NOW.Phrases.get("PAUSE_OFF_MSG"),type:NOW.Phrases.get("PAUSE_OFF"),dismiss:"cancel"}).then((async function(){try{await axios.delete(`${NOW.settings.url_api}/profile/mode/pause`);location.reload()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}}),(()=>{}))})),t.tpl.find('button[role="holidays-on"]').on("click",(async function(){const t=new Modal;let[e,a]=await Promise.all([t.loadFromServer("status-holidays",{}),NOW.Library.load(["ladda","axios","datepicker"])]);e.find('[data-plugin="datepicker"]').datepicker({language:"es",autoclose:!0,todayHighlight:!0,format:"dd/mm/yyyy"}),t.render(),e.on("submit",(async function(t){t.preventDefault();let e=new NOW.Form(t.target);if(e.lock())return!1;try{e.convertDate("pub_holidays_date","DD/MM/YYYY","YYYY-MM-DD");await axios.post(`${NOW.settings.url_api}/profile/pub`,e.serialize());location.reload()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}e.unlock()}))})),t.tpl.find('button[role="holidays-off"]').on("click",(async function(){await Promise.all([NOW.Library.load(["axios"])]);try{await axios.delete(`${NOW.settings.url_api}/profile/mode/holidays`);location.reload()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}})),t.tpl.find("#bannerUpload").dropzone({url:`${NOW.settings.url_api}/profile/banner`,method:"post",timeout:3e5,maxFilesize:5,createImageThumbnails:!1,acceptedFiles:"image/*",success:function(e){e=JSON.parse(e.xhr.response),console.log(e),t.tpl.find("#bannerImg").attr("src",`${NOW.settings.url_media}/${NOW.session.user_id}/banner.jpg?${e.banner_uploaded||"0"}`)}}),t.tpl.find('[role="avatarUpload"]').dropzone({url:`${NOW.settings.url_api}/profile/avatar`,method:"post",timeout:3e5,maxFilesize:20,createImageThumbnails:!1,acceptedFiles:"image/*",success:function(e){e=JSON.parse(e.xhr.response),t.tpl.find(".avatar img").attr("src",`${NOW.settings.url_media}/${NOW.session.user_id}/avatar.jpg?${e.avatar_uploaded||"0"}`)},error:async function(t,e,a){try{"Expired token"==e.message&&1==await Auth.refresh()&&this.uploadFile(t)}catch(t){console.log(t)}}}),t.tpl.find('a[data-toggle="tab"][href="#account-analytics"]').one("shown.bs.tab",(async function(){t.initAnalytics()})),t.tpl.find('a[data-toggle="tab"][href="#account-trips"]').one("shown.bs.tab",(async function(){t.initTrips()})),t.tpl.find('a[data-toggle="tab"][href="#account-purchases"]').one("shown.bs.tab",(async function(){t.initTransactions()})),t.tpl.find('span[role="triggerUpload"]').on("click",(function(t){t.stopPropagation(),window.scrollTo({top:0,behavior:"smooth"}),$("#header-upload-trigger").click()})),t.tpl.find("#newTrip").on("click",(async function(){const e=new Modal;let[a]=await Promise.all([e.loadFromServer("trip-new",{}),NOW.Library.load(["datepicker"])]);e.render(a);await a.find('select[name="trip_destination"]').select2region({minRegionLevel:2,allowClear:!1,customInputs:{country:"trip_country",province:"trip_province",city:"trip_city",zone:"trip_zone"},onChange:function(t){a.find('button[type="submit"]').attr("disabled",!1)},...0==t.options.plan_overseas?{allowedCountries:[t.options.pub_country]}:{}});a.find('[data-plugin="datepicker"]').datepicker({inline:!0,language:"es",autoclose:!0,todayHighlight:!0,format:"dd/mm/yyyy"}),a.find('[data-plugin="datepicker"]').on("changeDate",(function(){a.find("#trip_date").val($(this).datepicker("getFormattedDate"))})),a.on("submit",(async function(a){a.preventDefault();let i=new NOW.Form(a.target);if(i.lock())return!1;try{i.convertDate("trip_date","DD/MM/YYYY","YYYY-MM-DD");let a=await axios.post(`${NOW.settings.url_api}/profile/trip`,i.serialize());t.tripTable.row.add(a.data).draw(!1),e.hide()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}i.unlock()}))})),window.location.hash&&t.tpl.find(`a[href="${window.location.hash}"]`).tab("show")}async initTrips(){const t=this;let[e]=await Promise.all([fetch("/api/profile/trips"),t.regionInitialized,NOW.Library.load(["datatable","moment"])]);[e]=await Promise.all([e.json()]);var a={sDom:"<'overflow-auto horizontal-scroll't>",destroy:!0,scrollCollapse:!0,oLanguage:{sLengthMenu:"_MENU_ ",sInfo:"Mostrando registros _START_ al _END_ de un total de _TOTAL_",sInfoEmpty:"Mostrando registros _START_ al _END_ de un total de _TOTAL_",sInfoFiltered:"(filtrado de un total de _MAX_)",sLoadingRecords:"Cargando...",sProcessing:"Cargando...",sSearch:"_INPUT_",sSearchPlaceholder:"Buscar..",oPaginate:{sNext:"Proximo",sPrevious:"Previo"},sZeroRecords:"<strong>No hay viajes agendados</strong>"},iDisplayLength:30,order:[[0,"asc"]],bDeferRender:!0,aaData:e,autoWidth:!1,processing:!0,columns:[{mData:"trip_date",sTitle:"",bSearchable:!1,bSortable:!0,className:"v-align-middle trip-cell",mRender:function(t,e,a){return"display"==e?`\n\t\t\t\t\t\t\t\t\t<h6 class="mb-0">${moment(t).format("ll")}</h6>\n\t\t\t\t\t\t\t\t\t<div class="font-size-16 d-flex align-items-center">\n\t\t\t\t\t\t\t\t\t\t<img loading="lazy" src="${NOW.settings.url_static}/images/country-flag/${Cache.Region.get(a.trip_country,"region_code")}.svg" class="trip-flag h-20 pr-10">\n\t\t\t\t\t\t\t\t\t\t<div class="trip-destination">${Cache.Region.get(a.trip_country,"text")}</div>\n\t\t\t\t\t\t\t\t\t\t<div class="trip-destination trip-separator">${Cache.Region.get(a.trip_province,"text")}</div>\n\t\t\t\t\t\t\t\t\t\t<div class="trip-destination trip-separator">${Cache.Region.get(a.trip_city,"text")}</div>\n\t\t\t\t\t\t\t\t\t\t<div class="trip-destination trip-separator pr-10">${Cache.Region.get(a.trip_zone,"text")}</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t`:t}},{mData:"trip_id",sTitle:"",width:"1px",bSearchable:!1,bSortable:!1,className:"",mRender:function(t,e,a){return'<button type="button" class="btn mx-auto" role="deleteTrip"><i class="fal fa-trash"></i></button>'}}]};t.tripTable=t.tpl.find("#account-trips table").DataTable(a),t.tpl.find("#account-trips").on("click",'[role="deleteTrip"]',(async function(e){e.preventDefault();let a=$(this).parents("tr:first"),i=t.tripTable.row(a).data();try{await axios.delete(`${NOW.settings.url_api}/profile/trip/${i.trip_id}`),t.tripTable.row(a).remove().draw(!1)}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}}))}async initAnalytics(){const t=this;var e={tooltip:(t,e,a)=>{var i=`\n                        <div>\n                            <div><b>${moment(1e3*e).format("dddd DD, MMMM YYYY")}</b></div>`;for(let e in t)i+=`<div>${t[e]} <b>${Intl.NumberFormat().format(a[e])}</b></div>`;return i+"</div>"}};let[a,i]=await Promise.all([fetch("/api/profile/stats"),fetch("/api/profile/stats_event")]);[a,i]=await Promise.all([a.json(),i.json()]),t.graphs=[new NOW.Charts(e),new NOW.Charts(e)],await Promise.all([t.graphs[0].draw("#analytics-views",a,a.from,a.to),t.graphs[1].draw("#analytics-events",i,a.from,a.to)]),t.graphs[0].redraw(),t.graphs[1].redraw()}async initTransactions(){await NOW.Library.load(["transaction","datatable","moment"]),Transaction.purchasesPage(this.tpl.find("#account-purchases table"))}async modalSelect(t){var e=this.tpl.find(`div[data-tag-type="${t.dataset.target}"]`);t.dataset.selection=e.attr("data-selection");const a=new Modal;let i=await a.loadFromServer("modalSelect",{},t.dataset||{},!0);a.render(),i.find("form").on("submit",(async function(t){t.preventDefault();let i=new NOW.Form(t.target,t);if(i.lock())return!1;try{await axios.post(`${NOW.settings.url_api}/profile/pub`,i.serialize());let t=[];e.html("");for(let a of $(this).find("option:selected"))t.push(a.value),e.append(`<span class="account-tag">${a.text}</span>`);e.attr("data-selection",t.join(",")),await Alert.confirm({title:'<i class="fa fa-exclamation-circle fa-2x"></i>',msg:"Configuración guardada.",type:"OK"},{autoclose:1e3}),a.hide()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}i.unlock()}))}closeMenu(){this.tpl.find(".account-menu-container").addClass("menu-closed")}toggleMenu(){this.tpl.find(".account-menu-container").toggleClass("menu-closed")}}}(),function(){"use strict";NOW.Publication=class{constructor(t,e={}){this.pub_id=t,this.tpl=$("#page"),this.options=e}initialized=!1;async init(){const t=this;t.initialized||(t.initialized=!0,t.tpl.on("click",'[data-trigger^="Pub."],[data-trigger^="Gallery.delete"]',(function(e){const a=e.currentTarget;switch(void 0===a.dataset.allowPropagation&&e.stopPropagation(),a.dataset.trigger){case"Pub.complain":t.complain();break;case"Gallery.delete":t.deleteGallery(a)}})),t.initAbout(),t.initStories(),t.initGallery(),t.initGalleryFilter(),t.initShare(),t.initMap(),t.initFavCounter(),Post.init(),XP.init(),t.initXP(),await NOW.Library.load(["axios"]),t.xpSelector(),t.postSelector(),t.infinityScrollPosts())}initGalleryFilter(){const t=this;t.tpl.find("#gallery-filter").find("button").on("click",(function(e){if(e.preventDefault(),$(this).is(".btn-outline"))switch($(this).parent().find("button").addClass("btn-outline"),$(this).removeClass("btn-outline"),t.tpl.find(".pub-book-item").addClass("d-none"),$(this).attr("data-target")){case"photo":case"video":t.tpl.find(`.pub-book-item[data-media_type="${$(this).attr("data-target")}"]`).removeClass("d-none");break;case"verified":t.tpl.find('.pub-book-item[data-media_verified="1"]').removeClass("d-none")}else $(this).parent().find("button").addClass("btn-outline"),t.tpl.find(".pub-book-item").removeClass("d-none");t.initGallery()}))}galleryFirstRun=!0;initGallery(){const t=this;let e=null;if(t.tpl.find(".pub-book-item:not(.d-none) a.pub-book-link").magnificPopup({mainClass:"fade show",type:"inline",gallery:{enabled:!0},callbacks:{open:function(){$(".mfp-container").addClass("mfp-image-holder").removeClass("mfp-inline-holder"),$(".mfp-container").swipe({swipeLeft:function(t,e,a,i,n){console.log("left"),$.magnificPopup.instance.next()},swipeRight:function(t,e,a,i,n){console.log("right"),$.magnificPopup.instance.prev()}})},beforeClose:function(){console.log("beforeClose");let t=$(".mfp-container").find("video");t.length>0&&t[0].pause()},afterClose:function(){if(location.search.length){let t=location.toString().replace(location.search,"");window.history.pushState({query:t},"",t)}},change:function(t){if(null!=e){let t=e.find("video");t.length&&t[0].pause()}e=this.content;let a=this.content[0].querySelector("video"),i=this.index;a&&(a.preload="auto",a.readyState>=2?a.play():(a.load(),a.onloadeddata=t=>{a.readyState>=2&&i==$.magnificPopup.instance.index&&a.play()}));let n=$(t.el).parent().data(),o=`?m=${n.media_id}.${"photo"==n.media_type?"jpg":"mp4"}`;location.search.length?window.history.replaceState({query:o,plugin:"mpf",media_id:n.media_id},"",o):window.history.pushState({query:o,plugin:"mpf",media_id:n.media_id},"",o)}}}),t.galleryFirstRun){t.galleryFirstRun=!1,window.onpopstate=function(t){console.log(t.state),t.state&&t.state.plugin&&"mpf"==t.state.plugin?$(`a.pub-book-link[href="#media-${t.state.media_id}"]`).click():$.magnificPopup.close()};var a=new URLSearchParams(window.location.search);for(const[t,e]of a)"m"==t&&$(`a.pub-book-link[href="#media-${e.slice(0,-4)}"]`).click()}}async deleteGallery(t){const e=this,a=t.dataset;var i=$(t).closest(".pub-book-item");fetch(`/api/profile/media/${a.media_id}`,{method:"DELETE"}).then((async function(t){let a=await t.json();t.ok?(i.remove(),e.initGallery()):Alert.confirm({title:"Oops",msg:a.message||"",type:"OK"})})).catch((t=>{console.log(t)}))}initStories(){this.tpl.find(".listing-type-story").story()}initShare(){const t=this;navigator.share&&(t.tpl.find('button[role="share"]').removeClass("d-none"),t.tpl.find('button[role="share"]').on("click",(function(t){t.preventDefault(),navigator.share&&navigator.share({title:options.head_title??"",url:window.location.href}).then((()=>{console.log("Thanks for sharing!")})).catch(console.error)})))}initMap(){let t=this.tpl.find("iframe.map");t.length&&t.attr("src",t.attr("data-src"))}initAbout(){const t=this;t.tpl.find('a[role="show-full-about"]').on("click",(function(e){e.preventDefault(),t.tpl.find(".pub-about-preview").addClass("d-none"),t.tpl.find(".pub-about-full").removeClass("d-none")}))}initFavCounter(){const t=this.tpl.find("#favDropdown");t.length&&(FavList.load("like"),FavList.checked("like","{{pub.pub_id}}")&&t.find("#favDropdownIcon").addClass("font-weight-800"),t.on("click",(async function(){$(this).next().children().each((function(){let t=$(this);t.data("list_status",FavList.checked(t.data("list_type"),t.data("pub_id"))?"1":"0")}))})))}initXP(){this.tpl.find(".comment-xp").on("click",(function(){$(this).toggleClass("open")}))}async complain(){const t=this,e=new Modal;let[a]=await Promise.all([e.loadFromServer("complain",{}),NOW.Library.load(["ladda","axios"])]);e.render(),a.find("form").on("submit",(async function(a){a.preventDefault();let i=new NOW.Form(a.target);if(i.lock())return!1;try{let a=await axios.post(`${NOW.settings.url_api}/complain/${t.pub_id}`,i.serialize());await Alert.confirm({title:"",msg:a.data.message,type:"OK"}),e.hide()}catch(t){Alert.confirm({title:"Oops",msg:t.response.data.message||t,type:"OK"})}i.unlock()}))}postSelector(){const t=this;t.tpl.find("#pubPostViewSelector").on("change",(async function(){let e=await axios.get(`${NOW.settings.url_api}/pub/${t.pub_id}/posts`,{params:{from:0,view:$(this).val()}});const a=t.tpl.find("#posts-container");a.before(e.data.html),a.remove(),t.infinityScrollPosts()}))}infinityScrollPosts(){const t=this;let e=new IntersectionObserver((async(e,a)=>{for(let i of e){let e=i.target;if(i.isIntersecting&&1!=e.dataset.loading){e.dataset.loading=!0;const i=await axios.get(`${NOW.settings.url_api}/pub/${t.pub_id}/posts`,{params:{date:e.dataset.date,from:e.dataset.from,view:t.tpl.find("#pubPostViewSelector").val()}});if(e.dataset.from=parseInt(e.dataset.from)+20,i.data.html){document.getElementById("posts-container").insertAdjacentHTML("beforeend",i.data.html)}else a.unobserve(e);e.dataset.loading=!1}}}),{root:null,rootMargin:"0px 0px 500px 0px",threshold:0}),a=t.tpl.find("div[data-posts-loadmore]").get(0);a instanceof Element&&e.observe(a)}xpSelector(){const t=this;t.tpl.find("#pubXPViewSelector").on("change",(async function(){let e=await axios.get(`${NOW.settings.url_api}/xp/${t.pub_id}/${$(this).val()}`);const a=t.tpl.find("#xps-container");a.before(e.data.html),a.remove()}))}}}();